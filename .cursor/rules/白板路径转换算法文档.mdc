---
alwaysApply: false
---

# ç™½æ¿è·¯å¾„è½¬æ¢ç®—æ³•æ–‡æ¡£

## ğŸ¯ ç®—æ³•æ¦‚è¿°

ç™½æ¿è·¯å¾„è½¬æ¢ç®—æ³•è§£å†³äº†åœ¨æ‰¹é‡æ“ä½œä¸­ç»´æŠ¤å…ƒç´ è·¯å¾„ä¸€è‡´æ€§çš„æ ¸å¿ƒé—®é¢˜ã€‚å½“ç”¨æˆ·åŒæ—¶æ‰§è¡Œå¤šä¸ªæ“ä½œï¼ˆæ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨ã€è®¾ç½®ï¼‰æ—¶ï¼Œç¡®ä¿æ¯ä¸ªæ“ä½œçš„è·¯å¾„åœ¨æ‰§è¡Œæ—¶ä»ç„¶æœ‰æ•ˆã€‚

### æ ¸å¿ƒæŒ‘æˆ˜

- **è·¯å¾„å¤±æ•ˆ**ï¼šåˆ é™¤æ“ä½œå¯èƒ½ä½¿å…¶ä»–æ“ä½œçš„ç›®æ ‡è·¯å¾„æ— æ•ˆ
- **é¡ºåºä¾èµ–**ï¼šæ“ä½œæ‰§è¡Œé¡ºåºå½±å“æœ€ç»ˆç»“æœ
- **è·¯å¾„æ›´æ–°**ï¼šå‰åºæ“ä½œä¼šæ”¹å˜åç»­æ“ä½œçš„æœ‰æ•ˆè·¯å¾„

### è§£å†³æ–¹æ¡ˆ

ä¸‰æ­¥å¤„ç†æµç¨‹ï¼š**è¿‡æ»¤** â†’ **æ’åº** â†’ **è½¬æ¢**

## ğŸ”§ ç®—æ³•å®ç°

### ç¬¬ä¸€æ­¥ï¼šæ“ä½œè¿‡æ»¤ (`filterValidOperations`)

**ç›®æ ‡**ï¼šç§»é™¤å› ç¥–å…ˆåˆ é™¤è€Œæ— æ•ˆçš„æ“ä½œï¼ŒåŒæ—¶å¤„ç†"åˆ é™¤ååˆæ’å…¥"çš„ç‰¹æ®Šåœºæ™¯

**ç­–ç•¥**ï¼š

1. **æ”¶é›†åˆ é™¤å’Œæ’å…¥è·¯å¾„**ï¼šé¢„å…ˆæ”¶é›†æ‰€æœ‰åˆ é™¤å’Œæ’å…¥æ“ä½œçš„è·¯å¾„
2. **ç¥–å…ˆ-å­å­™è¿‡æ»¤**ï¼šè¿‡æ»¤æ‰ç›®æ ‡è·¯å¾„æ˜¯åˆ é™¤è·¯å¾„åä»£çš„æ“ä½œ
3. **é‡æ’å…¥è·¯å¾„æ£€æµ‹**ï¼šè¯†åˆ«"åˆ é™¤ååˆæ’å…¥"çš„è·¯å¾„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹‹å‰çš„æ“ä½œä»ç„¶æœ‰æ•ˆ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨Setè¿›è¡ŒO(1)å¿«é€Ÿè·¯å¾„æŸ¥æ‰¾

```typescript
// ç¤ºä¾‹1ï¼šç®€å•åˆ é™¤ä½¿åç»­æ“ä½œæ— æ•ˆ
operations = [
  { type: 'insert_node', path: [0, 1], node: {...} },  // æ— æ•ˆï¼šçˆ¶è·¯å¾„[0]è¢«åˆ é™¤
  { type: 'remove_node', path: [0], node: {...} }      // æœ‰æ•ˆ
]
// ç»“æœï¼šåªä¿ç•™åˆ é™¤æ“ä½œ

// ç¤ºä¾‹2ï¼šåˆ é™¤ååˆæ’å…¥ï¼Œä¹‹å‰çš„set_nodeæ“ä½œä»ç„¶æœ‰æ•ˆ
operations = [
  { type: 'set_node', path: [0], properties: {x: 0}, newProperties: {x: 50} },  // æœ‰æ•ˆ
  { type: 'set_node', path: [0], properties: {y: 0}, newProperties: {y: 25} },  // æœ‰æ•ˆ
  { type: 'remove_node', path: [0], node: {...} },     // æœ‰æ•ˆ
  { type: 'insert_node', path: [0], node: {...} }      // æœ‰æ•ˆ
]
// ç»“æœï¼šæ‰€æœ‰æ“ä½œéƒ½ä¿ç•™ï¼Œå› ä¸ºè·¯å¾„[0]è¢«åˆ é™¤ååˆè¢«é‡æ–°æ’å…¥
```

**æ ¸å¿ƒç®—æ³•**ï¼š

```typescript
// æ£€æŸ¥"åˆ é™¤ååˆæ’å…¥"çš„è·¯å¾„
const insertedPathSet = new Set(
  allInsertedPaths.map((path) => JSON.stringify(path)),
);
const reinsertedPaths = filteredDeletePaths.filter((deletedPath) =>
  insertedPathSet.has(JSON.stringify(deletedPath)),
);

// set_nodeæ“ä½œçš„ç‰¹æ®Šå¤„ç†
const isReinserted = reinsertedPathSet.has(pathStr);
if (!isReinserted && this.isPathDeleted(op.path, filteredDeletePaths)) {
  isValid = false;
}
```

### ç¬¬äºŒæ­¥ï¼šæ“ä½œæ’åº (`sortOperationsForExecution`)

**ç›®æ ‡**ï¼šç¡®ä¿æ“ä½œæ‰§è¡Œçš„ä¾èµ–å…³ç³»æ­£ç¡®

**æ’åºè§„åˆ™**ï¼š

1. æ“ä½œç±»å‹ä¼˜å…ˆçº§ï¼šå…¶ä»–æ“ä½œ â†’ æ’å…¥ â†’ è®¾ç½® â†’ åˆ é™¤
2. æ’å…¥æ“ä½œï¼šæ·±åº¦æµ…â†’æ·±ï¼ŒåŒå±‚ç´¢å¼•å°â†’å¤§ï¼ˆä¿è¯çˆ¶å…ƒç´ å…ˆäºå­å…ƒç´ æ’å…¥ï¼‰
3. åˆ é™¤æ“ä½œï¼šæ·±åº¦æ·±â†’æµ…ï¼ŒåŒå±‚ç´¢å¼•å¤§â†’å°ï¼ˆä¿è¯undoæ—¶çš„æ’å…¥é¡ºåºæ­£ç¡®ï¼‰

**æ’åºåŸå› **ï¼š

- **æ’å…¥æ’åº**ï¼šç¡®ä¿æ’å…¥å­å…ƒç´ æ—¶çˆ¶å…ƒç´ å·²å­˜åœ¨
- **åˆ é™¤æ’åº**ï¼šç¡®ä¿undoæ“ä½œï¼ˆåˆ é™¤çš„é€†æ“ä½œæ˜¯æ’å…¥ï¼‰æ—¶çˆ¶å­é¡ºåºæ­£ç¡®

```typescript
// æ’å…¥æ“ä½œç¤ºä¾‹ï¼šçˆ¶å…ƒç´ å¿…é¡»å…ˆæ’å…¥
[
  { type: 'insert_node', path: [0, 1], node: {...} },  // å­å…ƒç´ 
  { type: 'insert_node', path: [0], node: {...} }      // çˆ¶å…ƒç´ 
]
// æ’åºåï¼šå…ˆæ’å…¥[0]çˆ¶å…ƒç´ ï¼Œå†æ’å…¥[0,1]å­å…ƒç´ 

// åˆ é™¤æ“ä½œç¤ºä¾‹ï¼šä¸ºundoå‡†å¤‡æ­£ç¡®çš„æ’å…¥é¡ºåº
[
  { type: 'remove_node', path: [0] },      // çˆ¶å…ƒç´ 
  { type: 'remove_node', path: [0, 1] }    // å­å…ƒç´ 
]
// æ’åºåï¼šå…ˆåˆ [0,1]å­å…ƒç´ ï¼Œå†åˆ [0]çˆ¶å…ƒç´ 
// undoæ—¶ï¼šå…ˆæ’å…¥[0]çˆ¶å…ƒç´ ï¼Œå†æ’å…¥[0,1]å­å…ƒç´ 
```

### ç¬¬ä¸‰æ­¥ï¼šè·¯å¾„è½¬æ¢ (`transformValidOperations`)

**ç›®æ ‡**ï¼šå°†æ“ä½œè·¯å¾„è½¬æ¢ä¸ºæ‰§è¡Œæ—¶çš„å®é™…æœ‰æ•ˆè·¯å¾„

**è¿‡ç¨‹**ï¼š

1. **é¡ºåºå¤„ç†**ï¼šæŒ‰æ’åºé¡ºåºé€ä¸ªå¤„ç†æ“ä½œ
2. **ç´¯ç§¯å˜æ¢**ï¼šåŸºäºåŸå§‹è·¯å¾„è®¡ç®—å‰åºæ“ä½œçš„ç´¯ç§¯å½±å“ï¼Œé¿å…è½¬æ¢é“¾å¼è¯¯å·®
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜è·¯å¾„å˜æ¢ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
4. **ç‰¹æ®Šå¤„ç†**ï¼šä½¿ç”¨`targetOpType`å‚æ•°å¤„ç†è·¯å¾„å†²çªåœºæ™¯

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```typescript
// ç¼“å­˜è·¯å¾„å˜æ¢ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
const transformCache = new Map<string, Path | null>();

const cacheKey = `${JSON.stringify(originalPath)}-${currentOp.type}-${i}`;
if (transformCache.has(cacheKey)) {
  transformedPath = transformCache.get(cacheKey)!;
} else {
  transformedPath = this.calculateCumulativePathTransform(
    originalPath,
    operations.slice(0, i), // ä½¿ç”¨åŸå§‹æ“ä½œï¼Œé¿å…é“¾å¼è¯¯å·®
    currentOp.type,
  );
  transformCache.set(cacheKey, transformedPath);
}
```

## âš™ï¸ æ ¸å¿ƒæ–¹æ³•ï¼š`transformPath`

**æ–¹æ³•ç­¾å**ï¼š`transformPath(path: Path, operation: Operation, targetOpType?: string)`

**æ–°å¢å‚æ•° `targetOpType`**ï¼šæ ‡è¯†ç›®æ ‡è·¯å¾„æ‰€å±çš„æ“ä½œç±»å‹ï¼Œç”¨äºå¤„ç†è·¯å¾„å†²çªåœºæ™¯

### æ’å…¥æ“ä½œå½±å“

```typescript
// åœ¨[1]ä½ç½®æ’å…¥ï¼Œå½±å“åŒçº§åç»­å…ƒç´ 
[0] â†’ [0]  // ä¸å˜
[1] â†’ [2]  // +1
[2] â†’ [3]  // +1
```

### åˆ é™¤æ“ä½œå½±å“

```typescript
// åˆ é™¤[1]ä½ç½®ï¼Œå½±å“åŒçº§åç»­å…ƒç´ 
[0] â†’ [0]  // ä¸å˜
[2] â†’ [1]  // -1
[3] â†’ [2]  // -1
```

### è·¯å¾„å†²çªç‰¹æ®Šå¤„ç† ğŸ†•

**åœºæ™¯**ï¼šå½“åˆ é™¤å’Œæ’å…¥æ“ä½œæ¶‰åŠç›¸åŒè·¯å¾„æ—¶çš„å†²çªå¤„ç†

```typescript
// è·¯å¾„å†²çªï¼šåˆ é™¤[0]å’Œæ’å…¥[0]åŒæ—¶å­˜åœ¨
operations = [
  { type: 'remove_node', path: [0], node: {...} },
  { type: 'insert_node', path: [0], node: {...} }
]

// ä¼ ç»Ÿå¤„ç†ï¼šåˆ é™¤æ“ä½œä¼šä½¿æ’å…¥è·¯å¾„å¤±æ•ˆ
transformPath([0], removeOp) â†’ null  // æ’å…¥æ“ä½œå¤±æ•ˆ

// å†²çªå¤„ç†ï¼šä½¿ç”¨targetOpTypeå‚æ•°
transformPath([0], removeOp, 'insert_node') â†’ [0]  // æ’å…¥æ“ä½œä¿æŒæœ‰æ•ˆ

// å®ç°é€»è¾‘
if (targetOpType === "insert_node" && this.pathsEqual(path, opPath)) {
  return path; // åˆ é™¤æ“ä½œä¸å½±å“åŒè·¯å¾„çš„æ’å…¥æ“ä½œ
}
```

**åº”ç”¨åœºæ™¯**ï¼š

- å…ƒç´ çš„åˆ é™¤-é‡å»ºæ“ä½œåºåˆ—
- Undo-Redoç³»ç»Ÿä¸­çš„å¤æ‚æ“ä½œæ¢å¤
- æ‰¹é‡æ“ä½œä¸­çš„è·¯å¾„ä¸€è‡´æ€§ç»´æŠ¤

### Moveæ“ä½œå½±å“ â­

**æ ¸å¿ƒä¿®å¤**ï¼šMoveæ“ä½œæŒ‰åŸå­æ“ä½œå¤„ç†ï¼Œè€Œé"å…ˆåˆ åæ’"

#### åŒçº§Moveæ“ä½œ

```typescript
// Move [2] â†’ [0]
[0] â†’ [1]  // ä¸ºæ’å…¥è…¾ç©ºé—´
[1] â†’ [2]  // ä¸ºæ’å…¥è…¾ç©ºé—´
[2] â†’ [0]  // è¢«ç§»åŠ¨å…ƒç´ è·å¾—ç›®æ ‡ä½ç½®
[3] â†’ [2]  // å¡«è¡¥åˆ é™¤çš„ç©ºé—´
```

#### è·¨çº§Moveæ“ä½œ

```typescript
// Move [0,1] â†’ [1,0]
[0,1] â†’ [1,0]  // è¢«ç§»åŠ¨å…ƒç´ 
[0,2] â†’ [0,1]  // æºè·¯å¾„åŒçº§ï¼šåˆ é™¤å½±å“
[1,0] â†’ [1,1]  // ç›®æ ‡è·¯å¾„åŒçº§ï¼šæ’å…¥å½±å“
[2,0] â†’ [2,0]  // æ— å…³è·¯å¾„ä¸å˜
```

#### ç¥–å…ˆè·¯å¾„é‡æ„ ğŸ†•

**é‡è¦åœºæ™¯**ï¼šå½“`move_node`ç§»åŠ¨å…ƒç´ æ—¶ï¼Œè¢«ç§»åŠ¨å…ƒç´ çš„å­è·¯å¾„éœ€è¦é‡æ„ç¥–å…ˆéƒ¨åˆ†

```typescript
// Move [1,2] â†’ [3,0]ï¼Œå½±å“å­è·¯å¾„
[1,2] â†’ [3,0]        // è¢«ç§»åŠ¨å…ƒç´ æœ¬èº«
[1,2,0] â†’ [3,0,0]    // å­è·¯å¾„ï¼šç¥–å…ˆé‡æ„
[1,2,1] â†’ [3,0,1]    // å­è·¯å¾„ï¼šç¥–å…ˆé‡æ„
[1,2,0,5] â†’ [3,0,0,5] // æ·±å±‚å­è·¯å¾„ï¼šç¥–å…ˆé‡æ„

// å¯¹äºset_nodeæ“ä½œçš„å½±å“
move_node [0,1] â†’ [2,3]
set_node [0,1,0] â†’ [2,3,0]  // setæ“ä½œè·¯å¾„è·Ÿéšç§»åŠ¨
```

## ğŸš€ æ€§èƒ½ä¸æµ‹è¯•

### æ€§èƒ½æŒ‡æ ‡

- **ç®—æ³•æ€§èƒ½**ï¼š>4,000,000 ops/sec
- **æ—¶é—´å¤æ‚åº¦**ï¼šO(nÂ²) æœ€åæƒ…å†µï¼Œä½¿ç”¨ç¼“å­˜ä¼˜åŒ–é‡å¤è®¡ç®—
- **ç©ºé—´å¤æ‚åº¦**ï¼šO(n)ï¼Œé¢å¤–çš„ç¼“å­˜å¼€é”€
- **ä¼˜åŒ–æ•ˆæœ**ï¼šè·¯å¾„æŸ¥æ‰¾ O(n) â†’ O(1)ï¼Œé‡å¤è®¡ç®—å‡å°‘70-90%

### æµ‹è¯•æ¶æ„

```
ğŸ“ æµ‹è¯•æ–‡ä»¶ç»„ç»‡ï¼ˆ92ä¸ªæµ‹è¯•ï¼‰
â”œâ”€â”€ PathTransformCore.test.ts           (16) - transformPathæ ¸å¿ƒæ–¹æ³•ï¼Œå«è·¯å¾„å†²çªæµ‹è¯•
â”œâ”€â”€ PathTransform.basic.test.ts         (8)  - åŸºç¡€è½¬æ¢åœºæ™¯
â”œâ”€â”€ PathTransform.move.test.ts          (8)  - Moveæ“ä½œä¸“é¡¹
â”œâ”€â”€ PathTransform.move-set.test.ts      (7)  - Move-Setæ“ä½œé›†æˆæµ‹è¯•
â”œâ”€â”€ PathTransform.prefilter.test.ts     (7)  - è¿‡æ»¤ç®—æ³•
â”œâ”€â”€ PathTransform.parent.test.ts        (10) - çˆ¶å­å…³ç³»å¤„ç†
â”œâ”€â”€ FilterAndSort.test.ts               (9)  - è¿‡æ»¤æ’åºç®—æ³•
â”œâ”€â”€ PathTransform.integration.test.ts   (8)  - å®Œæ•´æµç¨‹æµ‹è¯•
â””â”€â”€ PathTransform.undo-redo.test.ts     (23) - Undo-Redoç³»ç»Ÿä¸“é¡¹æµ‹è¯• ğŸ†•
```

### Undo-Redoæµ‹è¯•è¦†ç›– ğŸ†•

**åŸºç¡€æµ‹è¯•ï¼ˆ4ä¸ªï¼‰**ï¼šé€†æ“ä½œç”Ÿæˆçš„æ­£ç¡®æ€§éªŒè¯

- insert_node â†” remove_node
- remove_node â†” insert_node
- move_node â†” move_nodeï¼ˆè·¯å¾„äº¤æ¢ï¼‰
- set_node â†” set_nodeï¼ˆå±æ€§äº¤æ¢ï¼‰

**æµç¨‹æµ‹è¯•ï¼ˆ4ä¸ªï¼‰**ï¼šåŸºæœ¬undo/redoæµç¨‹éªŒè¯

- ç®€å•æ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨æ“ä½œçš„undo
- æ‰¹é‡æ“ä½œçš„é€†åºundoæ‰§è¡Œ

**å¤æ‚åœºæ™¯æµ‹è¯•ï¼ˆ15ä¸ªï¼‰**ï¼š

- **è·¯å¾„å†²çª**ï¼šå¤šä¸ªæ“ä½œå½±å“ç›¸åŒè·¯å¾„çš„undoå¤„ç†
- **æ·±åº¦åµŒå¥—**ï¼šå¤æ‚å±‚çº§ç»“æ„çš„undo/redo
- **å¤§è§„æ¨¡æ‰¹é‡**ï¼š1000ä¸ªå…ƒç´ çš„æ€§èƒ½æµ‹è¯•ï¼ˆ<20msï¼‰
- **è¾¹ç•Œæƒ…å†µ**ï¼šç©ºåˆ—è¡¨ã€æ— æ•ˆè·¯å¾„çš„å®¹é”™å¤„ç†
- **è¿ç»­å¤šè½®**ï¼šå¤šè½®undo/redoå¾ªç¯æ“ä½œ
- **å¹¶å‘æ¨¡æ‹Ÿ**ï¼šå¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘çš„undoå¤„ç†
- **å¤æ‚ç§»åŠ¨é“¾**ï¼šè·¨å±‚çº§ç§»åŠ¨çš„undoå¤„ç†
- **åµŒå¥—ç»„åˆ**ï¼šåˆ†ç»„å’Œè§£ç»„æ“ä½œçš„undo
- **æé™è¾¹ç•Œ**ï¼šå•å…ƒç´ å¤æ‚æ“ä½œé“¾
- **é”™è¯¯æ¢å¤**ï¼šéƒ¨åˆ†å¤±è´¥æ“ä½œçš„undoå¤„ç†

**å…³é”®æŠ€æœ¯éªŒè¯**ï¼š

- é¢„å¤„ç†æ“ä½œä¸€è‡´æ€§ï¼ˆæ‰§è¡Œå’Œundoä½¿ç”¨ç›¸åŒé¢„å¤„ç†ï¼‰
- skipPathTransformæœºåˆ¶ï¼ˆundoæ“ä½œè·³è¿‡è·¯å¾„å˜æ¢ï¼‰
- åˆ é™¤-æ’å…¥å†²çªå¤„ç†ï¼ˆtargetOpTypeå‚æ•°åº”ç”¨ï¼‰

**Move-Seté›†æˆæµ‹è¯•æ¶µç›–åœºæ™¯**ï¼š

- ç¥–å…ˆè·¯å¾„é‡æ„ï¼šMoveå…ƒç´ æ—¶å…¶å­è·¯å¾„çš„Setæ“ä½œè·¯å¾„é‡æ„
- å¤æ‚å½±å“ç»„åˆï¼šç¥–å…ˆé‡æ„ã€åŒçº§å½±å“ã€æ— å…³è·¯å¾„çš„ç»¼åˆå¤„ç†
- æ·±å±‚åµŒå¥—ï¼šå¤šçº§å­è·¯å¾„çš„æ­£ç¡®é‡æ„
- è¾¹ç•Œæƒ…å†µï¼šç›¸åŒè·¯å¾„ã€å¹‚ç­‰æ€§éªŒè¯
- åŒçº§ç§»åŠ¨ï¼šå‘å‰/å‘åç§»åŠ¨å¯¹Setæ“ä½œçš„ä¸åŒå½±å“

## ğŸ“– ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•

```typescript
import { PathUtil } from "./PathUtil";
import { BoardOperations } from "./BoardOperations";

const operations = [
  { type: "remove_node", path: [0], node: { id: "1", type: "shape" } },
  { type: "insert_node", path: [1], node: { id: "2", type: "shape" } },
  { type: "move_node", path: [2], newPath: [0] },
];

// å®Œæ•´å¤„ç†æµç¨‹
const validOps = PathUtil.filterValidOperations(operations);
const sortedOps = PathUtil.sortOperationsForExecution(validOps);
const transformedOps = PathUtil.transformValidOperations(sortedOps);

// åº”ç”¨åˆ°ç™½æ¿
const newChildren = BoardOperations.applyToChildren(
  board.children,
  transformedOps,
);
```

### Undo-Redo ç”¨æ³• ğŸ†•

```typescript
import { BoardUtil } from "./BoardUtil";

// æ‰§è¡Œæ“ä½œå¹¶ç”Ÿæˆundo
const operations = [
  { type: "set_node", path: [0], properties: {x: 0}, newProperties: {x: 50} },
  { type: "remove_node", path: [0], node: {...} },
  { type: "insert_node", path: [0], node: {...} }
];

// 1. é¢„å¤„ç†æ“ä½œï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
const processedOps = PathUtil.transformValidOperations(
  PathUtil.sortOperationsForExecution(
    PathUtil.filterValidOperations(operations)
  )
);

// 2. æ‰§è¡Œæ“ä½œ
const afterState = BoardOperations.applyToChildren(initialState, processedOps);

// 3. ç”Ÿæˆundoæ“ä½œï¼ˆé€†åºï¼‰
const undoOps = processedOps
  .map(op => BoardUtil.inverseOperation(op))
  .reverse();

// 4. æ‰§è¡Œundoï¼ˆè·³è¿‡è·¯å¾„å˜æ¢ï¼Œå› ä¸ºå·²é¢„å¤„ç†ï¼‰
const undoState = BoardOperations.applyToChildren(afterState, undoOps, {
  skipPathTransform: true
});

// éªŒè¯ï¼šundoState åº”è¯¥ç­‰äº initialState
```

### å•æ­¥è°ƒè¯•

```typescript
// å•ç‹¬æµ‹è¯•è·¯å¾„è½¬æ¢
const moveOp = { type: "move_node", path: [2], newPath: [0] };
const transformedPath = PathUtil.transformPath([1], moveOp);
console.log(transformedPath); // [2] - åŸ[1]è¢«å‘åæ¨ç§»

// æµ‹è¯•è·¯å¾„å†²çªå¤„ç†
const removeOp = { type: "remove_node", path: [0], node: {...} };
const normalPath = PathUtil.transformPath([0], removeOp);
console.log(normalPath); // null - è·¯å¾„è¢«åˆ é™¤

const insertPath = PathUtil.transformPath([0], removeOp, "insert_node");
console.log(insertPath); // [0] - æ’å…¥æ“ä½œä¸å—åˆ é™¤å½±å“
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

```typescript
// å¯¹äºå¤§é‡æ“ä½œï¼Œç®—æ³•ä¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–
const largeOperations = Array.from({ length: 1000 }, (_, i) => ({
  type: "set_node",
  path: [i],
  properties: { x: 0 },
  newProperties: { x: 100 },
}));

// å¤„ç†è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ç¼“å­˜è·¯å¾„å˜æ¢ç»“æœ
const result = PathUtil.transformValidOperations(
  PathUtil.sortOperationsForExecution(
    PathUtil.filterValidOperations(largeOperations),
  ),
);

// æ€§èƒ½åŸºå‡†ï¼š1000ä¸ªæ“ä½œ < 20ms
```

## ğŸ” ç®—æ³•æ ¸å¿ƒç‰¹æ€§

### å…³é”®è®¾è®¡åŸåˆ™

1. **åŸå­æ€§Moveæ“ä½œ**ï¼šMoveæ“ä½œä¸æ˜¯"å…ˆåˆ åæ’"çš„å¤åˆæ“ä½œï¼Œè€Œæ˜¯åŸå­æ“ä½œã€‚è¢«ç§»åŠ¨çš„å…ƒç´ åº”è¯¥è·å¾—ç›®æ ‡ä½ç½®ï¼Œç¡®ä¿ç®—æ³•ç¬¦åˆçœŸå®çš„ä¸šåŠ¡éœ€æ±‚ã€‚

2. **è·¯å¾„å†²çªæ™ºèƒ½å¤„ç†**ï¼šé€šè¿‡`targetOpType`å‚æ•°ï¼Œç®—æ³•èƒ½å¤Ÿæ™ºèƒ½å¤„ç†åˆ é™¤-æ’å…¥è·¯å¾„å†²çªï¼Œç¡®ä¿æ“ä½œåºåˆ—çš„æ­£ç¡®æ‰§è¡Œã€‚

3. **ç¥–å…ˆè·¯å¾„é‡æ„**ï¼šå½“Moveæ“ä½œç§»åŠ¨å…ƒç´ æ—¶ï¼Œè¢«ç§»åŠ¨å…ƒç´ çš„å­è·¯å¾„èƒ½å¤Ÿæ­£ç¡®é‡æ„ç¥–å…ˆéƒ¨åˆ†ï¼Œä¿æŒå±‚çº§å…³ç³»çš„ä¸€è‡´æ€§ã€‚

4. **ç¼“å­˜ä¼˜åŒ–æ€§èƒ½**ï¼šä½¿ç”¨Set/Mapæ•°æ®ç»“æ„å’Œç»“æœç¼“å­˜ï¼Œå°†è·¯å¾„æŸ¥æ‰¾ä»O(n)ä¼˜åŒ–åˆ°O(1)ï¼Œé‡å¤è®¡ç®—å‡å°‘70-90%ã€‚

5. **Undo-Redoä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰§è¡Œæ“ä½œå’Œç”Ÿæˆundoæ“ä½œä½¿ç”¨ç›¸åŒçš„é¢„å¤„ç†é€»è¾‘ï¼Œé€šè¿‡skipPathTransformæœºåˆ¶ä¼˜åŒ–undoæ‰§è¡Œã€‚

### ç®—æ³•ä¼˜åŠ¿

- **å®Œæ•´æ€§**ï¼šæ”¯æŒæ‰€æœ‰ç±»å‹çš„è·¯å¾„è½¬æ¢ï¼ˆæ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨ã€è®¾ç½®ï¼‰
- **æ­£ç¡®æ€§**ï¼šå¤„ç†å¤æ‚çš„è·¯å¾„å†²çªå’Œå±‚çº§å…³ç³»
- **æ€§èƒ½**ï¼šå¤§è§„æ¨¡æ“ä½œåœºæ™¯ä¸‹çš„é«˜æ•ˆå¤„ç†
- **å¯é æ€§**ï¼šå…¨é¢çš„æµ‹è¯•è¦†ç›–å’Œè¾¹ç•Œæƒ…å†µå¤„ç†
- **æ‰©å±•æ€§**ï¼šæ¸…æ™°çš„æ¶æ„è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•

### é€‚ç”¨åœºæ™¯

- **ååŒç¼–è¾‘**ï¼šå¤šç”¨æˆ·åŒæ—¶æ“ä½œçš„è·¯å¾„ä¸€è‡´æ€§ç»´æŠ¤
- **æ‰¹é‡æ“ä½œ**ï¼šå¤§é‡å…ƒç´ çš„ç»Ÿä¸€å˜æ¢å¤„ç†
- **Undo-Redoç³»ç»Ÿ**ï¼šå¤æ‚æ“ä½œçš„å¯é æ’¤é”€æ¢å¤
- **æ•°æ®åŒæ­¥**ï¼šæ“ä½œåºåˆ—çš„æ­£ç¡®åº”ç”¨å’Œä¼ æ’­
- **ç™½æ¿ç³»ç»Ÿ**ï¼šå…ƒç´ å±‚çº§å’Œä½ç½®å…³ç³»çš„ç²¾ç¡®ç®¡ç†
# ç™½æ¿è·¯å¾„è½¬æ¢ç®—æ³•æ–‡æ¡£

## ğŸ¯ ç®—æ³•æ¦‚è¿°

ç™½æ¿è·¯å¾„è½¬æ¢ç®—æ³•è§£å†³äº†åœ¨æ‰¹é‡æ“ä½œä¸­ç»´æŠ¤å…ƒç´ è·¯å¾„ä¸€è‡´æ€§çš„æ ¸å¿ƒé—®é¢˜ã€‚å½“ç”¨æˆ·åŒæ—¶æ‰§è¡Œå¤šä¸ªæ“ä½œï¼ˆæ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨ã€è®¾ç½®ï¼‰æ—¶ï¼Œç¡®ä¿æ¯ä¸ªæ“ä½œçš„è·¯å¾„åœ¨æ‰§è¡Œæ—¶ä»ç„¶æœ‰æ•ˆã€‚

### æ ¸å¿ƒæŒ‘æˆ˜

- **è·¯å¾„å¤±æ•ˆ**ï¼šåˆ é™¤æ“ä½œå¯èƒ½ä½¿å…¶ä»–æ“ä½œçš„ç›®æ ‡è·¯å¾„æ— æ•ˆ
- **é¡ºåºä¾èµ–**ï¼šæ“ä½œæ‰§è¡Œé¡ºåºå½±å“æœ€ç»ˆç»“æœ
- **è·¯å¾„æ›´æ–°**ï¼šå‰åºæ“ä½œä¼šæ”¹å˜åç»­æ“ä½œçš„æœ‰æ•ˆè·¯å¾„

### è§£å†³æ–¹æ¡ˆ

ä¸‰æ­¥å¤„ç†æµç¨‹ï¼š**è¿‡æ»¤** â†’ **æ’åº** â†’ **è½¬æ¢**

## ğŸ”§ ç®—æ³•å®ç°

### ç¬¬ä¸€æ­¥ï¼šæ“ä½œè¿‡æ»¤ (`filterValidOperations`)

**ç›®æ ‡**ï¼šç§»é™¤å› ç¥–å…ˆåˆ é™¤è€Œæ— æ•ˆçš„æ“ä½œï¼ŒåŒæ—¶å¤„ç†"åˆ é™¤ååˆæ’å…¥"çš„ç‰¹æ®Šåœºæ™¯

**ç­–ç•¥**ï¼š

1. **æ”¶é›†åˆ é™¤å’Œæ’å…¥è·¯å¾„**ï¼šé¢„å…ˆæ”¶é›†æ‰€æœ‰åˆ é™¤å’Œæ’å…¥æ“ä½œçš„è·¯å¾„
2. **ç¥–å…ˆ-å­å­™è¿‡æ»¤**ï¼šè¿‡æ»¤æ‰ç›®æ ‡è·¯å¾„æ˜¯åˆ é™¤è·¯å¾„åä»£çš„æ“ä½œ
3. **é‡æ’å…¥è·¯å¾„æ£€æµ‹**ï¼šè¯†åˆ«"åˆ é™¤ååˆæ’å…¥"çš„è·¯å¾„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹‹å‰çš„æ“ä½œä»ç„¶æœ‰æ•ˆ
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨Setè¿›è¡ŒO(1)å¿«é€Ÿè·¯å¾„æŸ¥æ‰¾

```typescript
// ç¤ºä¾‹1ï¼šç®€å•åˆ é™¤ä½¿åç»­æ“ä½œæ— æ•ˆ
operations = [
  { type: 'insert_node', path: [0, 1], node: {...} },  // æ— æ•ˆï¼šçˆ¶è·¯å¾„[0]è¢«åˆ é™¤
  { type: 'remove_node', path: [0], node: {...} }      // æœ‰æ•ˆ
]
// ç»“æœï¼šåªä¿ç•™åˆ é™¤æ“ä½œ

// ç¤ºä¾‹2ï¼šåˆ é™¤ååˆæ’å…¥ï¼Œä¹‹å‰çš„set_nodeæ“ä½œä»ç„¶æœ‰æ•ˆ
operations = [
  { type: 'set_node', path: [0], properties: {x: 0}, newProperties: {x: 50} },  // æœ‰æ•ˆ
  { type: 'set_node', path: [0], properties: {y: 0}, newProperties: {y: 25} },  // æœ‰æ•ˆ
  { type: 'remove_node', path: [0], node: {...} },     // æœ‰æ•ˆ
  { type: 'insert_node', path: [0], node: {...} }      // æœ‰æ•ˆ
]
// ç»“æœï¼šæ‰€æœ‰æ“ä½œéƒ½ä¿ç•™ï¼Œå› ä¸ºè·¯å¾„[0]è¢«åˆ é™¤ååˆè¢«é‡æ–°æ’å…¥
```

**æ ¸å¿ƒç®—æ³•**ï¼š

```typescript
// æ£€æŸ¥"åˆ é™¤ååˆæ’å…¥"çš„è·¯å¾„
const insertedPathSet = new Set(
  allInsertedPaths.map((path) => JSON.stringify(path)),
);
const reinsertedPaths = filteredDeletePaths.filter((deletedPath) =>
  insertedPathSet.has(JSON.stringify(deletedPath)),
);

// set_nodeæ“ä½œçš„ç‰¹æ®Šå¤„ç†
const isReinserted = reinsertedPathSet.has(pathStr);
if (!isReinserted && this.isPathDeleted(op.path, filteredDeletePaths)) {
  isValid = false;
}
```

### ç¬¬äºŒæ­¥ï¼šæ“ä½œæ’åº (`sortOperationsForExecution`)

**ç›®æ ‡**ï¼šç¡®ä¿æ“ä½œæ‰§è¡Œçš„ä¾èµ–å…³ç³»æ­£ç¡®

**æ’åºè§„åˆ™**ï¼š

1. æ“ä½œç±»å‹ä¼˜å…ˆçº§ï¼šå…¶ä»–æ“ä½œ â†’ æ’å…¥ â†’ è®¾ç½® â†’ åˆ é™¤
2. æ’å…¥æ“ä½œï¼šæ·±åº¦æµ…â†’æ·±ï¼ŒåŒå±‚ç´¢å¼•å°â†’å¤§ï¼ˆä¿è¯çˆ¶å…ƒç´ å…ˆäºå­å…ƒç´ æ’å…¥ï¼‰
3. åˆ é™¤æ“ä½œï¼šæ·±åº¦æ·±â†’æµ…ï¼ŒåŒå±‚ç´¢å¼•å¤§â†’å°ï¼ˆä¿è¯undoæ—¶çš„æ’å…¥é¡ºåºæ­£ç¡®ï¼‰

**æ’åºåŸå› **ï¼š

- **æ’å…¥æ’åº**ï¼šç¡®ä¿æ’å…¥å­å…ƒç´ æ—¶çˆ¶å…ƒç´ å·²å­˜åœ¨
- **åˆ é™¤æ’åº**ï¼šç¡®ä¿undoæ“ä½œï¼ˆåˆ é™¤çš„é€†æ“ä½œæ˜¯æ’å…¥ï¼‰æ—¶çˆ¶å­é¡ºåºæ­£ç¡®

```typescript
// æ’å…¥æ“ä½œç¤ºä¾‹ï¼šçˆ¶å…ƒç´ å¿…é¡»å…ˆæ’å…¥
[
  { type: 'insert_node', path: [0, 1], node: {...} },  // å­å…ƒç´ 
  { type: 'insert_node', path: [0], node: {...} }      // çˆ¶å…ƒç´ 
]
// æ’åºåï¼šå…ˆæ’å…¥[0]çˆ¶å…ƒç´ ï¼Œå†æ’å…¥[0,1]å­å…ƒç´ 

// åˆ é™¤æ“ä½œç¤ºä¾‹ï¼šä¸ºundoå‡†å¤‡æ­£ç¡®çš„æ’å…¥é¡ºåº
[
  { type: 'remove_node', path: [0] },      // çˆ¶å…ƒç´ 
  { type: 'remove_node', path: [0, 1] }    // å­å…ƒç´ 
]
// æ’åºåï¼šå…ˆåˆ [0,1]å­å…ƒç´ ï¼Œå†åˆ [0]çˆ¶å…ƒç´ 
// undoæ—¶ï¼šå…ˆæ’å…¥[0]çˆ¶å…ƒç´ ï¼Œå†æ’å…¥[0,1]å­å…ƒç´ 
```

### ç¬¬ä¸‰æ­¥ï¼šè·¯å¾„è½¬æ¢ (`transformValidOperations`)

**ç›®æ ‡**ï¼šå°†æ“ä½œè·¯å¾„è½¬æ¢ä¸ºæ‰§è¡Œæ—¶çš„å®é™…æœ‰æ•ˆè·¯å¾„

**è¿‡ç¨‹**ï¼š

1. **é¡ºåºå¤„ç†**ï¼šæŒ‰æ’åºé¡ºåºé€ä¸ªå¤„ç†æ“ä½œ
2. **ç´¯ç§¯å˜æ¢**ï¼šåŸºäºåŸå§‹è·¯å¾„è®¡ç®—å‰åºæ“ä½œçš„ç´¯ç§¯å½±å“ï¼Œé¿å…è½¬æ¢é“¾å¼è¯¯å·®
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜è·¯å¾„å˜æ¢ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
4. **ç‰¹æ®Šå¤„ç†**ï¼šä½¿ç”¨`targetOpType`å‚æ•°å¤„ç†è·¯å¾„å†²çªåœºæ™¯

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```typescript
// ç¼“å­˜è·¯å¾„å˜æ¢ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
const transformCache = new Map<string, Path | null>();

const cacheKey = `${JSON.stringify(originalPath)}-${currentOp.type}-${i}`;
if (transformCache.has(cacheKey)) {
  transformedPath = transformCache.get(cacheKey)!;
} else {
  transformedPath = this.calculateCumulativePathTransform(
    originalPath,
    operations.slice(0, i), // ä½¿ç”¨åŸå§‹æ“ä½œï¼Œé¿å…é“¾å¼è¯¯å·®
    currentOp.type,
  );
  transformCache.set(cacheKey, transformedPath);
}
```

## âš™ï¸ æ ¸å¿ƒæ–¹æ³•ï¼š`transformPath`

**æ–¹æ³•ç­¾å**ï¼š`transformPath(path: Path, operation: Operation, targetOpType?: string)`

**æ–°å¢å‚æ•° `targetOpType`**ï¼šæ ‡è¯†ç›®æ ‡è·¯å¾„æ‰€å±çš„æ“ä½œç±»å‹ï¼Œç”¨äºå¤„ç†è·¯å¾„å†²çªåœºæ™¯

### æ’å…¥æ“ä½œå½±å“

```typescript
// åœ¨[1]ä½ç½®æ’å…¥ï¼Œå½±å“åŒçº§åç»­å…ƒç´ 
[0] â†’ [0]  // ä¸å˜
[1] â†’ [2]  // +1
[2] â†’ [3]  // +1
```

### åˆ é™¤æ“ä½œå½±å“

```typescript
// åˆ é™¤[1]ä½ç½®ï¼Œå½±å“åŒçº§åç»­å…ƒç´ 
[0] â†’ [0]  // ä¸å˜
[2] â†’ [1]  // -1
[3] â†’ [2]  // -1
```

### è·¯å¾„å†²çªç‰¹æ®Šå¤„ç† ğŸ†•

**åœºæ™¯**ï¼šå½“åˆ é™¤å’Œæ’å…¥æ“ä½œæ¶‰åŠç›¸åŒè·¯å¾„æ—¶çš„å†²çªå¤„ç†

```typescript
// è·¯å¾„å†²çªï¼šåˆ é™¤[0]å’Œæ’å…¥[0]åŒæ—¶å­˜åœ¨
operations = [
  { type: 'remove_node', path: [0], node: {...} },
  { type: 'insert_node', path: [0], node: {...} }
]

// ä¼ ç»Ÿå¤„ç†ï¼šåˆ é™¤æ“ä½œä¼šä½¿æ’å…¥è·¯å¾„å¤±æ•ˆ
transformPath([0], removeOp) â†’ null  // æ’å…¥æ“ä½œå¤±æ•ˆ

// å†²çªå¤„ç†ï¼šä½¿ç”¨targetOpTypeå‚æ•°
transformPath([0], removeOp, 'insert_node') â†’ [0]  // æ’å…¥æ“ä½œä¿æŒæœ‰æ•ˆ

// å®ç°é€»è¾‘
if (targetOpType === "insert_node" && this.pathsEqual(path, opPath)) {
  return path; // åˆ é™¤æ“ä½œä¸å½±å“åŒè·¯å¾„çš„æ’å…¥æ“ä½œ
}
```

**åº”ç”¨åœºæ™¯**ï¼š

- å…ƒç´ çš„åˆ é™¤-é‡å»ºæ“ä½œåºåˆ—
- Undo-Redoç³»ç»Ÿä¸­çš„å¤æ‚æ“ä½œæ¢å¤
- æ‰¹é‡æ“ä½œä¸­çš„è·¯å¾„ä¸€è‡´æ€§ç»´æŠ¤

### Moveæ“ä½œå½±å“ â­

**æ ¸å¿ƒä¿®å¤**ï¼šMoveæ“ä½œæŒ‰åŸå­æ“ä½œå¤„ç†ï¼Œè€Œé"å…ˆåˆ åæ’"

#### åŒçº§Moveæ“ä½œ

```typescript
// Move [2] â†’ [0]
[0] â†’ [1]  // ä¸ºæ’å…¥è…¾ç©ºé—´
[1] â†’ [2]  // ä¸ºæ’å…¥è…¾ç©ºé—´
[2] â†’ [0]  // è¢«ç§»åŠ¨å…ƒç´ è·å¾—ç›®æ ‡ä½ç½®
[3] â†’ [2]  // å¡«è¡¥åˆ é™¤çš„ç©ºé—´
```

#### è·¨çº§Moveæ“ä½œ

```typescript
// Move [0,1] â†’ [1,0]
[0,1] â†’ [1,0]  // è¢«ç§»åŠ¨å…ƒç´ 
[0,2] â†’ [0,1]  // æºè·¯å¾„åŒçº§ï¼šåˆ é™¤å½±å“
[1,0] â†’ [1,1]  // ç›®æ ‡è·¯å¾„åŒçº§ï¼šæ’å…¥å½±å“
[2,0] â†’ [2,0]  // æ— å…³è·¯å¾„ä¸å˜
```

#### ç¥–å…ˆè·¯å¾„é‡æ„ ğŸ†•

**é‡è¦åœºæ™¯**ï¼šå½“`move_node`ç§»åŠ¨å…ƒç´ æ—¶ï¼Œè¢«ç§»åŠ¨å…ƒç´ çš„å­è·¯å¾„éœ€è¦é‡æ„ç¥–å…ˆéƒ¨åˆ†

```typescript
// Move [1,2] â†’ [3,0]ï¼Œå½±å“å­è·¯å¾„
[1,2] â†’ [3,0]        // è¢«ç§»åŠ¨å…ƒç´ æœ¬èº«
[1,2,0] â†’ [3,0,0]    // å­è·¯å¾„ï¼šç¥–å…ˆé‡æ„
[1,2,1] â†’ [3,0,1]    // å­è·¯å¾„ï¼šç¥–å…ˆé‡æ„
[1,2,0,5] â†’ [3,0,0,5] // æ·±å±‚å­è·¯å¾„ï¼šç¥–å…ˆé‡æ„

// å¯¹äºset_nodeæ“ä½œçš„å½±å“
move_node [0,1] â†’ [2,3]
set_node [0,1,0] â†’ [2,3,0]  // setæ“ä½œè·¯å¾„è·Ÿéšç§»åŠ¨
```

## ğŸš€ æ€§èƒ½ä¸æµ‹è¯•

### æ€§èƒ½æŒ‡æ ‡

- **ç®—æ³•æ€§èƒ½**ï¼š>4,000,000 ops/sec
- **æ—¶é—´å¤æ‚åº¦**ï¼šO(nÂ²) æœ€åæƒ…å†µï¼Œä½¿ç”¨ç¼“å­˜ä¼˜åŒ–é‡å¤è®¡ç®—
- **ç©ºé—´å¤æ‚åº¦**ï¼šO(n)ï¼Œé¢å¤–çš„ç¼“å­˜å¼€é”€
- **ä¼˜åŒ–æ•ˆæœ**ï¼šè·¯å¾„æŸ¥æ‰¾ O(n) â†’ O(1)ï¼Œé‡å¤è®¡ç®—å‡å°‘70-90%

### æµ‹è¯•æ¶æ„

```
ğŸ“ æµ‹è¯•æ–‡ä»¶ç»„ç»‡ï¼ˆ92ä¸ªæµ‹è¯•ï¼‰
â”œâ”€â”€ PathTransformCore.test.ts           (16) - transformPathæ ¸å¿ƒæ–¹æ³•ï¼Œå«è·¯å¾„å†²çªæµ‹è¯•
â”œâ”€â”€ PathTransform.basic.test.ts         (8)  - åŸºç¡€è½¬æ¢åœºæ™¯
â”œâ”€â”€ PathTransform.move.test.ts          (8)  - Moveæ“ä½œä¸“é¡¹
â”œâ”€â”€ PathTransform.move-set.test.ts      (7)  - Move-Setæ“ä½œé›†æˆæµ‹è¯•
â”œâ”€â”€ PathTransform.prefilter.test.ts     (7)  - è¿‡æ»¤ç®—æ³•
â”œâ”€â”€ PathTransform.parent.test.ts        (10) - çˆ¶å­å…³ç³»å¤„ç†
â”œâ”€â”€ FilterAndSort.test.ts               (9)  - è¿‡æ»¤æ’åºç®—æ³•
â”œâ”€â”€ PathTransform.integration.test.ts   (8)  - å®Œæ•´æµç¨‹æµ‹è¯•
â””â”€â”€ PathTransform.undo-redo.test.ts     (23) - Undo-Redoç³»ç»Ÿä¸“é¡¹æµ‹è¯• ğŸ†•
```

### Undo-Redoæµ‹è¯•è¦†ç›– ğŸ†•

**åŸºç¡€æµ‹è¯•ï¼ˆ4ä¸ªï¼‰**ï¼šé€†æ“ä½œç”Ÿæˆçš„æ­£ç¡®æ€§éªŒè¯

- insert_node â†” remove_node
- remove_node â†” insert_node
- move_node â†” move_nodeï¼ˆè·¯å¾„äº¤æ¢ï¼‰
- set_node â†” set_nodeï¼ˆå±æ€§äº¤æ¢ï¼‰

**æµç¨‹æµ‹è¯•ï¼ˆ4ä¸ªï¼‰**ï¼šåŸºæœ¬undo/redoæµç¨‹éªŒè¯

- ç®€å•æ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨æ“ä½œçš„undo
- æ‰¹é‡æ“ä½œçš„é€†åºundoæ‰§è¡Œ

**å¤æ‚åœºæ™¯æµ‹è¯•ï¼ˆ15ä¸ªï¼‰**ï¼š

- **è·¯å¾„å†²çª**ï¼šå¤šä¸ªæ“ä½œå½±å“ç›¸åŒè·¯å¾„çš„undoå¤„ç†
- **æ·±åº¦åµŒå¥—**ï¼šå¤æ‚å±‚çº§ç»“æ„çš„undo/redo
- **å¤§è§„æ¨¡æ‰¹é‡**ï¼š1000ä¸ªå…ƒç´ çš„æ€§èƒ½æµ‹è¯•ï¼ˆ<20msï¼‰
- **è¾¹ç•Œæƒ…å†µ**ï¼šç©ºåˆ—è¡¨ã€æ— æ•ˆè·¯å¾„çš„å®¹é”™å¤„ç†
- **è¿ç»­å¤šè½®**ï¼šå¤šè½®undo/redoå¾ªç¯æ“ä½œ
- **å¹¶å‘æ¨¡æ‹Ÿ**ï¼šå¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘çš„undoå¤„ç†
- **å¤æ‚ç§»åŠ¨é“¾**ï¼šè·¨å±‚çº§ç§»åŠ¨çš„undoå¤„ç†
- **åµŒå¥—ç»„åˆ**ï¼šåˆ†ç»„å’Œè§£ç»„æ“ä½œçš„undo
- **æé™è¾¹ç•Œ**ï¼šå•å…ƒç´ å¤æ‚æ“ä½œé“¾
- **é”™è¯¯æ¢å¤**ï¼šéƒ¨åˆ†å¤±è´¥æ“ä½œçš„undoå¤„ç†

**å…³é”®æŠ€æœ¯éªŒè¯**ï¼š

- é¢„å¤„ç†æ“ä½œä¸€è‡´æ€§ï¼ˆæ‰§è¡Œå’Œundoä½¿ç”¨ç›¸åŒé¢„å¤„ç†ï¼‰
- skipPathTransformæœºåˆ¶ï¼ˆundoæ“ä½œè·³è¿‡è·¯å¾„å˜æ¢ï¼‰
- åˆ é™¤-æ’å…¥å†²çªå¤„ç†ï¼ˆtargetOpTypeå‚æ•°åº”ç”¨ï¼‰

**Move-Seté›†æˆæµ‹è¯•æ¶µç›–åœºæ™¯**ï¼š

- ç¥–å…ˆè·¯å¾„é‡æ„ï¼šMoveå…ƒç´ æ—¶å…¶å­è·¯å¾„çš„Setæ“ä½œè·¯å¾„é‡æ„
- å¤æ‚å½±å“ç»„åˆï¼šç¥–å…ˆé‡æ„ã€åŒçº§å½±å“ã€æ— å…³è·¯å¾„çš„ç»¼åˆå¤„ç†
- æ·±å±‚åµŒå¥—ï¼šå¤šçº§å­è·¯å¾„çš„æ­£ç¡®é‡æ„
- è¾¹ç•Œæƒ…å†µï¼šç›¸åŒè·¯å¾„ã€å¹‚ç­‰æ€§éªŒè¯
- åŒçº§ç§»åŠ¨ï¼šå‘å‰/å‘åç§»åŠ¨å¯¹Setæ“ä½œçš„ä¸åŒå½±å“

## ğŸ“– ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•

```typescript
import { PathUtil } from "./PathUtil";
import { BoardOperations } from "./BoardOperations";

const operations = [
  { type: "remove_node", path: [0], node: { id: "1", type: "shape" } },
  { type: "insert_node", path: [1], node: { id: "2", type: "shape" } },
  { type: "move_node", path: [2], newPath: [0] },
];

// å®Œæ•´å¤„ç†æµç¨‹
const validOps = PathUtil.filterValidOperations(operations);
const sortedOps = PathUtil.sortOperationsForExecution(validOps);
const transformedOps = PathUtil.transformValidOperations(sortedOps);

// åº”ç”¨åˆ°ç™½æ¿
const newChildren = BoardOperations.applyToChildren(
  board.children,
  transformedOps,
);
```

### Undo-Redo ç”¨æ³• ğŸ†•

```typescript
import { BoardUtil } from "./BoardUtil";

// æ‰§è¡Œæ“ä½œå¹¶ç”Ÿæˆundo
const operations = [
  { type: "set_node", path: [0], properties: {x: 0}, newProperties: {x: 50} },
  { type: "remove_node", path: [0], node: {...} },
  { type: "insert_node", path: [0], node: {...} }
];

// 1. é¢„å¤„ç†æ“ä½œï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
const processedOps = PathUtil.transformValidOperations(
  PathUtil.sortOperationsForExecution(
    PathUtil.filterValidOperations(operations)
  )
);

// 2. æ‰§è¡Œæ“ä½œ
const afterState = BoardOperations.applyToChildren(initialState, processedOps);

// 3. ç”Ÿæˆundoæ“ä½œï¼ˆé€†åºï¼‰
const undoOps = processedOps
  .map(op => BoardUtil.inverseOperation(op))
  .reverse();

// 4. æ‰§è¡Œundoï¼ˆè·³è¿‡è·¯å¾„å˜æ¢ï¼Œå› ä¸ºå·²é¢„å¤„ç†ï¼‰
const undoState = BoardOperations.applyToChildren(afterState, undoOps, {
  skipPathTransform: true
});

// éªŒè¯ï¼šundoState åº”è¯¥ç­‰äº initialState
```

### å•æ­¥è°ƒè¯•

```typescript
// å•ç‹¬æµ‹è¯•è·¯å¾„è½¬æ¢
const moveOp = { type: "move_node", path: [2], newPath: [0] };
const transformedPath = PathUtil.transformPath([1], moveOp);
console.log(transformedPath); // [2] - åŸ[1]è¢«å‘åæ¨ç§»

// æµ‹è¯•è·¯å¾„å†²çªå¤„ç†
const removeOp = { type: "remove_node", path: [0], node: {...} };
const normalPath = PathUtil.transformPath([0], removeOp);
console.log(normalPath); // null - è·¯å¾„è¢«åˆ é™¤

const insertPath = PathUtil.transformPath([0], removeOp, "insert_node");
console.log(insertPath); // [0] - æ’å…¥æ“ä½œä¸å—åˆ é™¤å½±å“
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

```typescript
// å¯¹äºå¤§é‡æ“ä½œï¼Œç®—æ³•ä¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–
const largeOperations = Array.from({ length: 1000 }, (_, i) => ({
  type: "set_node",
  path: [i],
  properties: { x: 0 },
  newProperties: { x: 100 },
}));

// å¤„ç†è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨ç¼“å­˜è·¯å¾„å˜æ¢ç»“æœ
const result = PathUtil.transformValidOperations(
  PathUtil.sortOperationsForExecution(
    PathUtil.filterValidOperations(largeOperations),
  ),
);

// æ€§èƒ½åŸºå‡†ï¼š1000ä¸ªæ“ä½œ < 20ms
```

## ğŸ” ç®—æ³•æ ¸å¿ƒç‰¹æ€§

### å…³é”®è®¾è®¡åŸåˆ™

1. **åŸå­æ€§Moveæ“ä½œ**ï¼šMoveæ“ä½œä¸æ˜¯"å…ˆåˆ åæ’"çš„å¤åˆæ“ä½œï¼Œè€Œæ˜¯åŸå­æ“ä½œã€‚è¢«ç§»åŠ¨çš„å…ƒç´ åº”è¯¥è·å¾—ç›®æ ‡ä½ç½®ï¼Œç¡®ä¿ç®—æ³•ç¬¦åˆçœŸå®çš„ä¸šåŠ¡éœ€æ±‚ã€‚

2. **è·¯å¾„å†²çªæ™ºèƒ½å¤„ç†**ï¼šé€šè¿‡`targetOpType`å‚æ•°ï¼Œç®—æ³•èƒ½å¤Ÿæ™ºèƒ½å¤„ç†åˆ é™¤-æ’å…¥è·¯å¾„å†²çªï¼Œç¡®ä¿æ“ä½œåºåˆ—çš„æ­£ç¡®æ‰§è¡Œã€‚

3. **ç¥–å…ˆè·¯å¾„é‡æ„**ï¼šå½“Moveæ“ä½œç§»åŠ¨å…ƒç´ æ—¶ï¼Œè¢«ç§»åŠ¨å…ƒç´ çš„å­è·¯å¾„èƒ½å¤Ÿæ­£ç¡®é‡æ„ç¥–å…ˆéƒ¨åˆ†ï¼Œä¿æŒå±‚çº§å…³ç³»çš„ä¸€è‡´æ€§ã€‚

4. **ç¼“å­˜ä¼˜åŒ–æ€§èƒ½**ï¼šä½¿ç”¨Set/Mapæ•°æ®ç»“æ„å’Œç»“æœç¼“å­˜ï¼Œå°†è·¯å¾„æŸ¥æ‰¾ä»O(n)ä¼˜åŒ–åˆ°O(1)ï¼Œé‡å¤è®¡ç®—å‡å°‘70-90%ã€‚

5. **Undo-Redoä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰§è¡Œæ“ä½œå’Œç”Ÿæˆundoæ“ä½œä½¿ç”¨ç›¸åŒçš„é¢„å¤„ç†é€»è¾‘ï¼Œé€šè¿‡skipPathTransformæœºåˆ¶ä¼˜åŒ–undoæ‰§è¡Œã€‚

### ç®—æ³•ä¼˜åŠ¿

- **å®Œæ•´æ€§**ï¼šæ”¯æŒæ‰€æœ‰ç±»å‹çš„è·¯å¾„è½¬æ¢ï¼ˆæ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨ã€è®¾ç½®ï¼‰
- **æ­£ç¡®æ€§**ï¼šå¤„ç†å¤æ‚çš„è·¯å¾„å†²çªå’Œå±‚çº§å…³ç³»
- **æ€§èƒ½**ï¼šå¤§è§„æ¨¡æ“ä½œåœºæ™¯ä¸‹çš„é«˜æ•ˆå¤„ç†
- **å¯é æ€§**ï¼šå…¨é¢çš„æµ‹è¯•è¦†ç›–å’Œè¾¹ç•Œæƒ…å†µå¤„ç†
- **æ‰©å±•æ€§**ï¼šæ¸…æ™°çš„æ¶æ„è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•

### é€‚ç”¨åœºæ™¯

- **ååŒç¼–è¾‘**ï¼šå¤šç”¨æˆ·åŒæ—¶æ“ä½œçš„è·¯å¾„ä¸€è‡´æ€§ç»´æŠ¤
- **æ‰¹é‡æ“ä½œ**ï¼šå¤§é‡å…ƒç´ çš„ç»Ÿä¸€å˜æ¢å¤„ç†
- **Undo-Redoç³»ç»Ÿ**ï¼šå¤æ‚æ“ä½œçš„å¯é æ’¤é”€æ¢å¤
- **æ•°æ®åŒæ­¥**ï¼šæ“ä½œåºåˆ—çš„æ­£ç¡®åº”ç”¨å’Œä¼ æ’­
- **ç™½æ¿ç³»ç»Ÿ**ï¼šå…ƒç´ å±‚çº§å’Œä½ç½®å…³ç³»çš„ç²¾ç¡®ç®¡ç†
