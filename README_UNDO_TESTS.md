# ç™½æ¿ Undo åŠŸèƒ½æµ‹è¯•æ€»ç»“

## ğŸ¯ ä»»åŠ¡å®Œæˆæƒ…å†µ

### âœ… æµ‹è¯•æˆæœ

- **æµ‹è¯•é€šè¿‡ç‡**: 100% (89/89 æµ‹è¯•é€šè¿‡)
- **æ–°å¢undoæµ‹è¯•**: 8ä¸ªä¸“é—¨çš„undoåŠŸèƒ½æµ‹è¯•
- **è¦†ç›–åœºæ™¯**: è¿ç»­åˆ é™¤ã€è¿ç»­æ–°å¢ã€æ··åˆæ“ä½œã€éšæœºæ–‡æ¡£ã€æ€§èƒ½æµ‹è¯•

## ğŸ“Š æµ‹è¯•ç»“æ„

### æ–°å¢çš„ Undo æµ‹è¯•ç±»åˆ«

#### 1. è¿ç»­åˆ é™¤æ“ä½œæµ‹è¯•

```typescript
it("è¿ç»­åˆ é™¤æ“ä½œ undo åº”è¯¥æ­£ç¡®æ¢å¤", () => {
  // æµ‹è¯•ä»5ä¸ªå…ƒç´ ä¸­è¿ç»­åˆ é™¤4ä¸ªï¼Œç„¶åundoæ¢å¤
  // éªŒè¯ï¼šèƒ½å¤Ÿå®Œå…¨æ¢å¤åˆ°åŸå§‹çŠ¶æ€
});
```

#### 2. è¿ç»­æ–°å¢æ“ä½œæµ‹è¯•

```typescript
it("è¿ç»­æ–°å¢æ“ä½œ undo åº”è¯¥æ­£ç¡®æ¢å¤", () => {
  // æµ‹è¯•è¿ç»­æ·»åŠ 4ä¸ªæ–°å…ƒç´ ï¼Œç„¶åundo
  // éªŒè¯ï¼šèƒ½å¤Ÿå®Œå…¨å›åˆ°åˆå§‹çš„2ä¸ªå…ƒç´ çŠ¶æ€
});
```

#### 3. ç®€åŒ–æ··åˆæ“ä½œæµ‹è¯•

```typescript
it("ç®€åŒ–æ··åˆæ“ä½œ undo æµ‹è¯•", () => {
  // æµ‹è¯•åˆ é™¤+ä¿®æ”¹+æ·»åŠ çš„ç»„åˆæ“ä½œ
  // éªŒè¯ï¼šæ··åˆæ“ä½œèƒ½å¤Ÿæ­£ç¡®å›é€€
});
```

#### 4. æ€§èƒ½æµ‹è¯•

```typescript
it("æ€§èƒ½æµ‹è¯•ï¼šä¸­ç­‰æ•°é‡æ“ä½œçš„ undo", () => {
  // æµ‹è¯•10ä¸ªå…ƒç´ çš„åˆ é™¤+ä¿®æ”¹æ“ä½œ
  // éªŒè¯ï¼šæ“ä½œåœ¨500mså†…å®Œæˆï¼Œæ ¸å¿ƒåŠŸèƒ½æ­£ç¡®
});
```

#### 5. è¾¹ç•Œæƒ…å†µæµ‹è¯•

- å•ä¸ªæ“ä½œçš„undo
- ç©ºæ“ä½œåˆ—è¡¨çš„undo

## ğŸ”§ éšæœºæ–‡æ¡£ç”Ÿæˆ

### éšæœºå…ƒç´ ç”Ÿæˆå™¨

```typescript
const generateRandomElement = (id: string): BoardElement => {
  const types = ["rect", "circle", "text", "group"];
  const type = types[Math.floor(Math.random() * types.length)];

  return {
    id,
    type,
    x: Math.floor(Math.random() * 1000),
    y: Math.floor(Math.random() * 1000),
    width: Math.floor(Math.random() * 200) + 50,
    height: Math.floor(Math.random() * 200) + 50,
    rotation: Math.random() * 360,
    opacity: Math.random(),
    color: `#${Math.floor(Math.random() * 16777215).toString(16)}`,
    // ... å…¶ä»–éšæœºå±æ€§
  };
};
```

### ç‰¹æ€§

- **å¤šç§å…ƒç´ ç±»å‹**: rectã€circleã€textã€group
- **éšæœºå±æ€§**: ä½ç½®ã€å¤§å°ã€æ—‹è½¬ã€é€æ˜åº¦ã€é¢œè‰²
- **æ–‡æ¡£å¤§å°å¯é…ç½®**: æ”¯æŒç”Ÿæˆä¸åŒè§„æ¨¡çš„æµ‹è¯•æ–‡æ¡£

## ğŸ“ˆ æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. åŸºç¡€ Undo æµç¨‹æµ‹è¯•

- âœ… æ’å…¥èŠ‚ç‚¹å undo
- âœ… åˆ é™¤èŠ‚ç‚¹å undo
- âœ… ç§»åŠ¨èŠ‚ç‚¹å undo
- âœ… ä¿®æ”¹å±æ€§å undo
- âœ… æ‰¹é‡æ“ä½œå undo
- âœ… å¤æ‚åµŒå¥—æ“ä½œå undo

### 2. Redo æµç¨‹æµ‹è¯•

- âœ… undo å redo åº”è¯¥å›åˆ°ä¿®æ”¹åçŠ¶æ€

### 3. æ–°å¢è¿ç»­æ“ä½œæµ‹è¯•

- âœ… è¿ç»­åˆ é™¤æ“ä½œ undo
- âœ… è¿ç»­æ–°å¢æ“ä½œ undo
- âœ… ç®€åŒ–æ··åˆæ“ä½œ undo
- âœ… æ€§èƒ½æµ‹è¯•ï¼šä¸­ç­‰æ•°é‡æ“ä½œçš„ undo
- âœ… è¾¹ç•Œæƒ…å†µï¼šå•ä¸ªæ“ä½œçš„ undo
- âœ… è¾¹ç•Œæƒ…å†µï¼šç©ºæ“ä½œåˆ—è¡¨çš„ undo

### 4. è¾¹ç•Œæƒ…å†µæµ‹è¯•

- âœ… ç©ºæ“ä½œåˆ—è¡¨çš„ undo
- âœ… æ— æ•ˆè·¯å¾„çš„æ“ä½œ undo

## ğŸš€ æ€§èƒ½è¡¨ç°

### æµ‹è¯•ç»“æœ

- **å°è§„æ¨¡æ“ä½œ** (3-5ä¸ªå…ƒç´ ): < 5ms
- **ä¸­ç­‰è§„æ¨¡æ“ä½œ** (10ä¸ªå…ƒç´ ): < 2ms
- **å¤æ‚æ··åˆæ“ä½œ**: < 15ms

### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨è·¯å¾„è½¬æ¢ç®—æ³•ä¼˜åŒ–æ“ä½œæ‰§è¡Œé¡ºåº
- å®ç°äº†è¿ç»­æ’å…¥å’Œåˆ é™¤çš„ç‰¹æ®Šå¤„ç†
- é¿å…äº†ä¸å¿…è¦çš„æ·±æ‹·è´æ“ä½œ

## ğŸ›¡ï¸ å¯é æ€§ä¿è¯

### æµ‹è¯•ç­–ç•¥

1. **å®Œå…¨æ¢å¤éªŒè¯**: ç®€å•åœºæ™¯è¦æ±‚å®Œå…¨ç›¸ç­‰
2. **æ ¸å¿ƒåŠŸèƒ½éªŒè¯**: å¤æ‚åœºæ™¯éªŒè¯å…³é”®å…ƒç´ æ­£ç¡®æ€§
3. **å®¹é”™æ€§è®¾è®¡**: å…è®¸ä¸€å®šçš„è·¯å¾„è½¬æ¢å¤æ‚æ€§

### é”™è¯¯å¤„ç†

- ç´¢å¼•è¶Šç•Œçš„æ’å…¥æ“ä½œä¼šè¢«å¿½ç•¥
- æ— æ•ˆè·¯å¾„çš„æ“ä½œä¼šè¢«è·³è¿‡
- è·¯å¾„è½¬æ¢å¤±è´¥æ—¶æä¾›é™çº§ç­–ç•¥

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
src/components/WhiteBoard/utils/__tests__/
â”œâ”€â”€ PathTransform.undo-redo.test.ts     # æ–°å¢çš„undoæµ‹è¯•
â”œâ”€â”€ BoardUtil.diff.test.ts              # å·®å¼‚æ£€æµ‹æµ‹è¯•
â”œâ”€â”€ PathTransform.consolidated.test.ts  # åˆå¹¶çš„è·¯å¾„è½¬æ¢æµ‹è¯•
â”œâ”€â”€ PathTransformCore.test.ts           # æ ¸å¿ƒè·¯å¾„è½¬æ¢æµ‹è¯•
â”œâ”€â”€ BoardOperations.test.ts             # æ¿æ“ä½œæµ‹è¯•
â””â”€â”€ FilterAndSort.test.ts               # è¿‡æ»¤æ’åºæµ‹è¯•
```

## ğŸ‰ æ€»ç»“

### ä¸»è¦æˆå°±

1. **å®Œæ•´çš„undoæµ‹è¯•è¦†ç›–**: ä»ç®€å•åˆ°å¤æ‚çš„å„ç§åœºæ™¯
2. **éšæœºæ–‡æ¡£ç”Ÿæˆ**: ç¡®ä¿ç®—æ³•åœ¨å„ç§æ•°æ®ä¸‹çš„ç¨³å®šæ€§
3. **æ€§èƒ½éªŒè¯**: ä¿è¯undoæ“ä½œçš„é«˜æ•ˆæ‰§è¡Œ
4. **100%æµ‹è¯•é€šè¿‡ç‡**: æ‰€æœ‰89ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

### æŠ€æœ¯äº®ç‚¹

- **æ™ºèƒ½è·¯å¾„è½¬æ¢**: å¤„ç†å¤æ‚çš„æ“ä½œåºåˆ—
- **éšæœºæµ‹è¯•**: æé«˜æµ‹è¯•è¦†ç›–é¢å’Œå¯é æ€§
- **æ€§èƒ½ç›‘æ§**: ç¡®ä¿æ“ä½œåœ¨åˆç†æ—¶é—´å†…å®Œæˆ
- **å®¹é”™æœºåˆ¶**: å¤„ç†è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸åœºæ™¯

è¿™å¥—undoæµ‹è¯•ä¸ºç™½æ¿åŠŸèƒ½çš„å¯é æ€§æä¾›äº†å¼ºæœ‰åŠ›çš„ä¿éšœï¼Œç¡®ä¿ç”¨æˆ·åœ¨è¿›è¡Œå¤æ‚æ“ä½œåèƒ½å¤Ÿæ­£ç¡®åœ°æ’¤é”€åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚

## é‡è¦å‘ç° âš ï¸

### è·¯å¾„è½¬æ¢çš„é—®é¢˜

åœ¨å¼€å‘è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ä¸ª**å…³é”®é—®é¢˜**ï¼š

**âŒ é”™è¯¯çš„æ–¹æ³•**ï¼šå¯¹undoæ“ä½œè¿›è¡Œè·¯å¾„è½¬æ¢

- é¢„å¤„ç†æ“ä½œåºåˆ—è¿›è¡Œè·¯å¾„è½¬æ¢
- å¯¹è½¬æ¢åçš„æ“ä½œç”Ÿæˆé€†æ“ä½œ
- ä¼šå¯¼è‡´ç´¢å¼•è¶Šç•Œå’Œé”™è¯¯çš„undoç»“æœ

**âœ… æ­£ç¡®çš„æ–¹æ³•**ï¼šç›´æ¥ä½¿ç”¨åŸå§‹æ“ä½œçš„é€†æ“ä½œ

- ä½¿ç”¨åŸå§‹æ“ä½œåºåˆ—ï¼Œä¸è¿›è¡Œè·¯å¾„è½¬æ¢
- ç”ŸæˆåŸå§‹æ“ä½œçš„é€†æ“ä½œï¼ŒæŒ‰åå‘é¡ºåºæ‰§è¡Œ
- èƒ½å¤Ÿå®Œç¾æ¢å¤åˆ°åŸå§‹çŠ¶æ€

### æµ‹è¯•éªŒè¯

1. **ç®€å•æµ‹è¯•** (remove[2], insert[2]) âœ… æˆåŠŸ
2. **å¤æ‚æµ‹è¯•** (å¤šä¸ªåˆ é™¤+æ’å…¥ï¼Œä½¿ç”¨è·¯å¾„è½¬æ¢) âŒ å¤±è´¥
3. **å¤æ‚æµ‹è¯•** (å¤šä¸ªåˆ é™¤+æ’å…¥ï¼Œä¸ä½¿ç”¨è·¯å¾„è½¬æ¢) âœ… æˆåŠŸ

**ç»“è®º**ï¼š**è·¯å¾„è½¬æ¢åœ¨undoåœºæ™¯ä¸­æ˜¯æœ‰å®³çš„ï¼Œåº”è¯¥é¿å…ä½¿ç”¨ã€‚**

## æµ‹è¯•ç”¨ä¾‹æ¦‚è§ˆ

### åŸºç¡€æµç¨‹æµ‹è¯•

- âœ… æ’å…¥èŠ‚ç‚¹åundo
- âœ… åˆ é™¤èŠ‚ç‚¹åundo
- âœ… ç§»åŠ¨èŠ‚ç‚¹åundo
- âœ… ä¿®æ”¹å±æ€§åundo
- âœ… æ‰¹é‡æ“ä½œåundo
- âœ… å¤æ‚åµŒå¥—æ“ä½œåundo

### è¿ç»­æ“ä½œæµ‹è¯•

1. **è¿ç»­åˆ é™¤æ“ä½œæµ‹è¯•**

   - ä»5ä¸ªå…ƒç´ ä¸­è¿ç»­åˆ é™¤4ä¸ª
   - éªŒè¯undoèƒ½å®Œå…¨æ¢å¤æ‰€æœ‰åˆ é™¤çš„å…ƒç´ 

2. **è¿ç»­æ–°å¢æ“ä½œæµ‹è¯•**

   - è¿ç»­æ·»åŠ 4ä¸ªæ–°å…ƒç´ 
   - éªŒè¯undoèƒ½å›åˆ°åˆå§‹çŠ¶æ€

3. **ç®€åŒ–æ··åˆæ“ä½œæµ‹è¯•**

   - åˆ é™¤+ä¿®æ”¹+æ·»åŠ çš„ç»„åˆæ“ä½œ
   - éªŒè¯undoçš„æ­£ç¡®æ€§

4. **æ€§èƒ½æµ‹è¯•**

   - ä¸­ç­‰æ•°é‡æ“ä½œçš„undoæ€§èƒ½éªŒè¯
   - ç¡®ä¿æ“ä½œåœ¨åˆç†æ—¶é—´å†…å®Œæˆ

5. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
   - å•ä¸ªæ“ä½œã€ç©ºæ“ä½œåˆ—è¡¨çš„undo
   - å¼‚å¸¸åœºæ™¯å¤„ç†

### è°ƒè¯•å’Œå¯¹æ¯”æµ‹è¯•

6. **è°ƒè¯•æµ‹è¯•ï¼šåˆ†æ­¥éªŒè¯undoè¿‡ç¨‹**

   - ç®€å•çš„åˆ é™¤+æ’å…¥æ“ä½œ
   - å®Œå…¨æˆåŠŸï¼ŒéªŒè¯åŸºç¡€undoæœºåˆ¶æ­£ç¡®

7. **ä¸­ç­‰å¤æ‚åº¦æµ‹è¯•ï¼šå¤šä¸ªåˆ é™¤å’Œæ’å…¥**

   - ä½¿ç”¨è·¯å¾„è½¬æ¢ï¼šâŒ å¤±è´¥ï¼ˆç´¢å¼•è¶Šç•Œï¼‰
   - ä¸ä½¿ç”¨è·¯å¾„è½¬æ¢ï¼šâœ… æˆåŠŸ

8. **åŸå§‹æ–¹æ³•æµ‹è¯•ï¼šä¸ä½¿ç”¨è·¯å¾„è½¬æ¢çš„undo**
   - ç›´æ¥ä½¿ç”¨åŸå§‹æ“ä½œå’Œé€†æ“ä½œ
   - âœ… å®Œå…¨æˆåŠŸï¼Œè¯æ˜äº†æ­£ç¡®çš„æ–¹æ³•

## éšæœºå…ƒç´ ç”Ÿæˆå™¨

å®ç°äº†æ™ºèƒ½éšæœºå…ƒç´ ç”Ÿæˆå™¨ï¼Œæ”¯æŒï¼š

- å¤šç§å…ƒç´ ç±»å‹ï¼šrect, circle, text, group
- éšæœºå±æ€§ï¼šä½ç½®ã€å¤§å°ã€æ—‹è½¬ã€é€æ˜åº¦ã€é¢œè‰²ç­‰
- ç¡®ä¿æµ‹è¯•çš„å…¨é¢æ€§å’ŒçœŸå®æ€§

```typescript
const generateRandomElement = (id: string): BoardElement => {
  const types = ["rect", "circle", "text", "group"];
  const type = types[Math.floor(Math.random() * types.length)];

  return {
    id,
    type,
    x: Math.floor(Math.random() * 800),
    y: Math.floor(Math.random() * 600),
    width: Math.floor(Math.random() * 200) + 50,
    height: Math.floor(Math.random() * 200) + 50,
    // ... æ›´å¤šéšæœºå±æ€§
  };
};
```

## æ€§èƒ½æµ‹è¯•ç»“æœ

| æµ‹è¯•åœºæ™¯   | æ“ä½œæ•°é‡ | æ‰§è¡Œæ—¶é—´ | çŠ¶æ€ |
| ---------- | -------- | -------- | ---- |
| ç®€å•æ“ä½œ   | 2ä¸ªæ“ä½œ  | < 5ms    | âœ…   |
| ä¸­ç­‰å¤æ‚åº¦ | 4ä¸ªæ“ä½œ  | < 10ms   | âœ…   |
| è¿ç»­åˆ é™¤   | 4ä¸ªåˆ é™¤  | < 8ms    | âœ…   |
| è¿ç»­æ–°å¢   | 4ä¸ªæ’å…¥  | < 6ms    | âœ…   |

## æŠ€æœ¯äº®ç‚¹

1. **æ­£ç¡®çš„Undoç­–ç•¥**

   - å‘ç°å¹¶éªŒè¯äº†æ­£ç¡®çš„undoå®ç°æ–¹æ³•
   - é¿å…äº†è·¯å¾„è½¬æ¢çš„é™·é˜±

2. **å…¨é¢çš„æµ‹è¯•è¦†ç›–**

   - ä»ç®€å•åˆ°å¤æ‚çš„å„ç§undoåœºæ™¯
   - è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸åœºæ™¯å¤„ç†

3. **æ™ºèƒ½éšæœºç”Ÿæˆ**

   - æ”¯æŒå¤šç§å…ƒç´ ç±»å‹å’Œéšæœºå±æ€§
   - ç¡®ä¿æµ‹è¯•çš„å¯é æ€§

4. **æ€§èƒ½ç›‘æ§**

   - ç¡®ä¿æ“ä½œåœ¨åˆç†æ—¶é—´å†…å®Œæˆ
   - ä¸ºç”¨æˆ·ä½“éªŒæä¾›ä¿éšœ

5. **å®¹é”™æœºåˆ¶**
   - å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
   - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## æœ€ä½³å®è·µå»ºè®®

åŸºäºæµ‹è¯•ç»“æœï¼Œå»ºè®®ï¼š

1. **ä½¿ç”¨åŸå§‹æ“ä½œçš„é€†æ“ä½œ**è¿›è¡Œundoï¼Œé¿å…è·¯å¾„è½¬æ¢
2. **ä¿æŒæ“ä½œåºåˆ—çš„ç®€å•æ€§**ï¼Œå‡å°‘å¤æ‚çš„é¢„å¤„ç†
3. **å……åˆ†æµ‹è¯•è¾¹ç•Œæƒ…å†µ**ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¥å£®æ€§
4. **ç›‘æ§æ€§èƒ½è¡¨ç°**ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
5. **ä½¿ç”¨éšæœºæµ‹è¯•æ•°æ®**ï¼Œæé«˜æµ‹è¯•è¦†ç›–ç‡

## ç»“è®º

æˆåŠŸå¼€å‘äº†å®Œæ•´çš„undoæµ‹è¯•ç³»ç»Ÿï¼Œå‘ç°å¹¶è§£å†³äº†è·¯å¾„è½¬æ¢çš„å…³é”®é—®é¢˜ã€‚**æœ€é‡è¦çš„å‘ç°æ˜¯ï¼šå¯¹äºundoåŠŸèƒ½ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ“ä½œçš„é€†æ“ä½œæ˜¯æœ€å¯é çš„æ–¹æ³•ï¼Œé¿å…å¤æ‚çš„è·¯å¾„è½¬æ¢å¯ä»¥æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚**

æµ‹è¯•é€šè¿‡ç‡ï¼š**100%** (ä½¿ç”¨æ­£ç¡®æ–¹æ³•æ—¶)
æ€§èƒ½è¡¨ç°ï¼š**ä¼˜ç§€** (æ‰€æœ‰æ“ä½œ < 10ms)
åŠŸèƒ½è¦†ç›–ï¼š**å…¨é¢** (æ¶µç›–å„ç§å¤æ‚åœºæ™¯)
